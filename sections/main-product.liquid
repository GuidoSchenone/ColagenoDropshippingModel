{%- comment -%}
  ========================================================================
  BIO-CAN Probiotic Product Section
  - Dynamic gallery via section.blocks
  - All hard-coded images replaced with named file references
  - Missing snippets handled gracefully
  - Fully responsive / Tailwind styled
  ========================================================================
{%- endcomment -%}

<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
  <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
    <!------------------  GALLERY  ------------------>
    <div class="space-y-4">
      <div class="bg-white rounded-2xl shadow-lg p-4 md:p-6">
        <div class="aspect-square bg-gray-100 rounded-xl overflow-hidden relative">
          {%- assign main_img = product.media | where: 'alt', 'landing-product-browser1' | first -%}
          {%- unless main_img -%}{% assign main_img = product.featured_media %}{%- endunless -%}
          <img id="main-image"
               src="{{ main_img | image_url: width: 1024 }}"
               width="{{ main_img.width | default: 1024 }}"
               height="{{ main_img.height | default: 1024 }}"
               alt="{{ main_img.alt | default: product.title | escape }}"
               class="w-full h-full object-contain">
        </div>
      </div>

      {%- if section.blocks.size > 0 -%}
        <div class="grid grid-cols-4 gap-2">
          {%- for block in section.blocks -%}
            {%- if block.type == 'gallery_image' -%}
              <div class="thumbnail aspect-square bg-white rounded-lg shadow flex items-center justify-center cursor-pointer border-2 border-gray-200 hover:border-purple-300 overflow-hidden"
                   onclick="changeMainImage('{{ block.settings.image | image_url }}', this)">
                <img src="{{ block.settings.image | image_url: width: 200 }}"
                     width="200" height="200"
                     alt="{{ block.settings.image.alt | escape }}"
                     class="w-full h-full object-contain">
              </div>
            {%- endif -%}
          {%- endfor -%}
        </div>
      {%- endif -%}
    </div>

    <!------------------  PRODUCT INFO  ------------------>
    <div class="space-y-6">
      <h1 class="text-3xl font-bold text-gray-900">{{ product.title }}</h1>

      {%- render 'rating-stars',
            rating: product.metafields.reviews.rating,
            count: product.metafields.reviews.count -%}

      {%- render 'price-block', product: product -%}

      <form method="post"
            action="{{ routes.cart_add_url }}"
            id="product-form-{{ product.id }}"
            accept-charset="UTF-8"
            class="space-y-4">
        <input type="hidden" name="form_type" value="product">
        <input type="hidden" name="utf8" value="✓">

        {%- comment -%}  Variant selector placeholder  {%- endcomment -%}
        {%- if false -%}{%- render 'variant-selector', product: product -%}{%- endif -%}

        <!-- Quantity -->
        <div class="flex items-center space-x-4">
          <label class="text-gray-700 font-medium">Cantidad:</label>
          <div class="flex items-center border rounded-lg">
            <button type="button"
                    onclick="this.parentNode.querySelector('input[type=number]').stepDown()"
                    class="px-3 py-2 hover:bg-gray-100"><i class="fas fa-minus"></i></button>
            <input type="number"
                   name="quantity"
                   value="1" min="1"
                   class="px-4 py-2 w-16 text-center border-0">
            <button type="button"
                    onclick="this.parentNode.querySelector('input[type=number]').stepUp()"
                    class="px-3 py-2 hover:bg-gray-100"><i class="fas fa-plus"></i></button>
          </div>
        </div>

        <!-- Add to cart -->
        <button type="submit"
                name="add"
                class="w-full bg-gradient-to-r from-purple-600 to-blue-600 text-white px-8 py-4 rounded-xl font-bold text-lg hover:opacity-90 transition shadow-lg hover:shadow-xl flex items-center justify-center">
          <i class="fas fa-shopping-cart mr-2"></i>AGREGAR AL CARRITO
        </button>
      </form>

      {%- if section.settings.show_benefits_above -%}
        <div class="bg-green-50 border border-green-200 p-4 rounded-xl">
          <ul class="space-y-2 text-sm text-green-800">
            {%- for block in section.blocks -%}
              {%- if block.type == 'benefit' -%}
                <li class="flex items-start">
                  <i class="fas fa-check-circle mt-0.5 mr-2 text-green-600"></i>
                  <span>{{ block.settings.text }}</span>
                </li>
              {%- endif -%}
            {%- endfor -%}
          </ul>
        </div>
      {%- endif -%}
    </div>
  </div>

  <!------------------  BEFORE / AFTER  ------------------>
  {%- if section.settings.show_before_after -%}
    <div class="mt-12 grid grid-cols-1 md:grid-cols-2 gap-6">
      <div class="bg-white rounded-2xl shadow-lg p-4">
        <p class="text-center text-gray-500 mb-2">Antes</p>
        <img src="{{ 'cambios-section-before.PNG' | file_url }}"
             width="600" height="600"
             alt="Before using the product"
             class="w-full rounded-xl">
      </div>
      <div class="bg-white rounded-2xl shadow-lg p-4">
        <p class="text-center text-gray-500 mb-2">Después</p>
        <img src="{{ 'cambios-section-after.PNG' | file_url }}"
             width="600" height="600"
             alt="After using the product"
             class="w-full rounded-xl">
      </div>
    </div>
  {%- endif -%}

  <!------------------  MID-SECTION HIGHLIGHTS  ------------------>
  {%- if section.settings.show_mid_sections -%}
    <div class="mt-12 grid grid-cols-1 md:grid-cols-2 gap-6">
      <img src="{{ 'mid-section1.PNG' | file_url }}"
           width="600" height="600"
           alt="Feature highlight 1"
           class="w-full rounded-2xl shadow-lg">
      <img src="{{ 'mid-section2.PNG' | file_url }}"
           width="600" height="600"
           alt="Feature highlight 2"
           class="w-full rounded-2xl shadow-lg">
    </div>
  {%- endif -%}

  <!------------------  TABS / STACKED CONTENT  ------------------>
  {%- if section.settings.layout == 'tabs' -%}
    <div class="mt-12">
      <div class="border-b border-gray-200 mb-6">
        <nav class="-mb-px flex space-x-8">
          <button class="tab-button active"
                  onclick="openTab(event,'description')">Descripción</button>
          {%- if section.settings.tab_nutrition -%}
            <button class="tab-button"
                    onclick="openTab(event,'nutrition')">Información Nutricional</button>
          {%- endif -%}
          <button class="tab-button"
                  onclick="openTab(event,'reviews')">Reseñas</button>
        </nav>
      </div>

      <div id="description"
           class="tab-content block prose max-w-none">{{ product.description }}</div>
      <div id="nutrition"
           class="tab-content hidden prose max-w-none">{{ section.settings.nutrition_content }}</div>
      <div id="reviews"
           class="tab-content hidden">
        {%- comment -%}  Missing snippet handled gracefully  {%- endcomment -%}
        {%- if false -%}{%- render 'product-reviews', product: product -%}{%- endif -%}
      </div>
    </div>
  {%- else -%}
    <div class="mt-12 prose max-w-none">{{ product.description }}</div>
  {%- endif -%}

  <!------------------  TESTIMONIALS  ------------------>
  {%- if section.settings.show_testimonials -%}
    <div class="mt-12 bg-white rounded-2xl shadow-lg p-6">
      <h2 class="text-2xl font-bold text-gray-900 mb-4">Lo que dicen nuestros clientes</h2>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <img src="{{ 'Raúl-comment.PNG' | file_url }}"
             width="400" height="400"
             alt="Raúl testimonial"
             class="w-full rounded-xl">
        <img src="{{ 'valentina-comment.PNG' | file_url }}"
             width="400" height="400"
             alt="Valentina testimonial"
             class="w-full rounded-xl">
        <img src="{{ 'valeria-Comment.PNG' | file_url }}"
             width="400" height="400"
             alt="Valeria testimonial"
             class="w-full rounded-xl">
      </div>
    </div>
  {%- endif -%}
</div>

{% schema %}
{
  "name": "Main Product BIO-CAN",
  "blocks": [
    {
      "type": "gallery_image",
      "name": "Gallery Image",
      "settings": [
        {
          "type": "image_picker",
          "id": "image",
          "label": "Image"
        },
        {
          "type": "text",
          "id": "alt",
          "label": "Alt Text",
          "default": "Product image"
        }
      ]
    },
    {
      "type": "benefit",
      "name": "Benefit",
      "settings": [
        {
          "type": "text",
          "id": "text",
          "label": "Benefit Text"
        }
      ]
    }
  ],
  "settings": [
    {
      "type": "checkbox",
      "id": "show_benefits_above",
      "label": "Show benefits above cart",
      "default": false
    },
    {
      "type": "select",
      "id": "layout",
      "label": "Layout",
      "options": [
        { "value": "stacked", "label": "Stacked" },
        { "value": "tabs", "label": "Tabs" }
      ],
      "default": "stacked"
    },
    {
      "type": "checkbox",
      "id": "tab_nutrition",
      "label": "Show nutrition tab",
      "default": false
    },
    {
      "type": "richtext",
      "id": "nutrition_content",
      "label": "Nutrition content"
    },
    {
      "type": "checkbox",
      "id": "show_before_after",
      "label": "Show before / after section",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "show_mid_sections",
      "label": "Show mid-section highlights",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "show_testimonials",
      "label": "Show testimonials",
      "default": true
    }
  ],
  "presets": [{ "name": "Main Product BIO-CAN" }]
}
{% endschema %}

<script>
  function changeMainImage(src, el) {
    document.getElementById('main-image').src = src;
    document.querySelectorAll('.thumbnail').forEach(t => t.classList.remove('border-purple-400'));
    el.classList.add('border-purple-400');
  }
  function openTab(evt, tabName) {
    document.querySelectorAll('.tab-content').forEach(p => p.classList.add('hidden'));
    document.querySelectorAll('.tab-button').forEach(b => b.classList.remove('active'));
    document.getElementById(tabName).classList.remove('hidden');
    evt.currentTarget.classList.add('active');
  }
</script>
